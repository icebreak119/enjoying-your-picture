<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>{% if error_404 %}页面未找到{% elif error_500 %}服务器错误{% elif error_413 %}文件过大{% else %}图片分享站{% endif %}</title>
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.1.3/dist/css/bootstrap.min.css" rel="stylesheet">
    <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/bootstrap-icons@1.8.1/font/bootstrap-icons.css">
    <link rel="stylesheet" href="{{ url_for('static', filename='css/style.css') }}">
    <link rel="icon" type="image/x-icon" href="https://img.icons8.com/color/48/000000/image--v1.png">
    <style>
        /* 动态渐变背景 */
        body {
            min-height: 100vh;
            display: flex;
            flex-direction: column;
            margin: 0;
            padding: 0;
            background: linear-gradient(-45deg, #ee7752, #e73c7e, #23a6d5, #23d5ab);
            background-size: 400% 400%;
            animation: gradientBG 15s ease infinite;
            position: relative;
            transition: padding-bottom 0.3s ease;
        }

        /* 当有音乐播放器时调整底部间距 */
        body.has-music-player {
            padding-bottom: 100px;
        }

        /* 背景动画 */
        @keyframes gradientBG {
            0% {
                background-position: 0% 50%;
            }
            50% {
                background-position: 100% 50%;
            }
            100% {
                background-position: 0% 50%;
            }
        }

        /* 半透明遮罩层，确保内容可读 */
        body::before {
            content: '';
            position: fixed;
            top: 0;
            left: 0;
            right: 0;
            bottom: 0;
            background: rgba(255, 255, 255, 0.85);
            z-index: -1;
        }

        /* 主要内容区域半透明 */
        main.container {
            background: rgba(255, 255, 255, 0.92);
            border-radius: 15px;
            padding: 20px;
            box-shadow: 0 5px 25px rgba(0, 0, 0, 0.1);
            margin-top: 30px;
            margin-bottom: 30px;
            transition: margin-bottom 0.3s ease;
        }

        /* 导航栏半透明 */
        .navbar {
            background: rgba(33, 37, 41, 0.95) !important;
            backdrop-filter: blur(10px);
            box-shadow: 0 2px 15px rgba(0, 0, 0, 0.2);
        }

        /* 卡片半透明 */
        .card {
            background: rgba(255, 255, 255, 0.95);
            backdrop-filter: blur(5px);
            border: 1px solid rgba(255, 255, 255, 0.2);
            transition: transform 0.3s, box-shadow 0.3s;
        }

        .card:hover {
            transform: translateY(-5px);
            box-shadow: 0 10px 25px rgba(0, 0, 0, 0.15) !important;
        }

        /* 页脚半透明 */
        .footer {
            background: rgba(33, 37, 41, 0.95) !important;
            backdrop-filter: blur(10px);
            transition: margin-bottom 0.3s ease;
        }

        /* 警告框半透明 */
        .alert {
            background: rgba(255, 255, 255, 0.95);
            backdrop-filter: blur(5px);
            border: 1px solid rgba(0, 0, 0, 0.1);
        }

        /* Jumbotron 半透明 */
        .jumbotron {
            background: rgba(248, 249, 250, 0.95) !important;
            backdrop-filter: blur(5px);
            border: 1px solid rgba(255, 255, 255, 0.3);
        }

        /* 按钮半透明效果 */
        .btn-primary, .btn-secondary, .btn-danger, .btn-outline-primary, .btn-outline-secondary {
            backdrop-filter: blur(5px);
        }

        /* 分页半透明 */
        .pagination .page-item .page-link {
            background: rgba(255, 255, 255, 0.9);
            border: 1px solid rgba(0, 0, 0, 0.1);
        }

        .pagination .page-item.active .page-link {
            background: rgba(13, 110, 253, 0.9);
        }

        /* 滚动条美化 */
        ::-webkit-scrollbar {
            width: 10px;
        }

        ::-webkit-scrollbar-track {
            background: rgba(255, 255, 255, 0.1);
            border-radius: 5px;
        }

        ::-webkit-scrollbar-thumb {
            background: rgba(0, 0, 0, 0.2);
            border-radius: 5px;
        }

        ::-webkit-scrollbar-thumb:hover {
            background: rgba(0, 0, 0, 0.3);
        }

        /* 原有样式保留 */
        .text-truncate-2 {
            display: -webkit-box;
            -webkit-line-clamp: 2;
            -webkit-box-orient: vertical;
            overflow: hidden;
        }

        .img-container {
            height: 200px;
            overflow: hidden;
            border-radius: 10px 10px 0 0;
        }

        .img-container img {
            width: 100%;
            height: 100%;
            object-fit: cover;
            transition: transform 0.5s ease;
        }

        .img-container img:hover {
            transform: scale(1.08);
        }

        /* ================== 音乐播放器样式 ================== */
        .music-player {
            position: fixed;
            bottom: 80px;
            right: 20px;
            z-index: 1000;
            transition: all 0.3s ease;
            max-width: 350px;
            font-family: -apple-system, BlinkMacSystemFont, "Segoe UI", Roboto, "Helvetica Neue", Arial, sans-serif;
        }

        .music-player.collapsed {
            width: 60px;
            height: 60px;
        }

        .music-player.expanded {
            width: 350px;
            background: rgba(255, 255, 255, 0.95);
            backdrop-filter: blur(10px);
            border-radius: 15px;
            box-shadow: 0 10px 30px rgba(0, 0, 0, 0.2);
            overflow: hidden;
            border: 1px solid rgba(255, 255, 255, 0.3);
        }

        /* 播放器头部 */
        .player-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            padding: 15px;
            background: linear-gradient(135deg, #e1306c, #ff7e5f);
            color: white;
            cursor: pointer;
        }

        .player-header h5 {
            margin: 0;
            font-size: 16px;
            display: flex;
            align-items: center;
            gap: 8px;
        }

        .player-header .close-btn {
            background: none;
            border: none;
            color: white;
            font-size: 20px;
            cursor: pointer;
            padding: 5px;
            border-radius: 50%;
            transition: background 0.3s;
        }

        .player-header .close-btn:hover {
            background: rgba(255, 255, 255, 0.2);
        }

        /* 播放器内容容器 */
        .player-content {
            display: none;
        }

        .music-player.expanded .player-content {
            display: block;
        }

        .music-player.expanded .mini-player {
            display: none;
        }

        .music-player.collapsed .player-content {
            display: none;
        }

        .music-player.collapsed .mini-player {
            display: flex;
        }

        /* 迷你播放器 */
        .mini-player {
            width: 60px;
            height: 60px;
            border-radius: 50%;
            background: linear-gradient(135deg, #e1306c, #ff7e5f);
            display: flex;
            align-items: center;
            justify-content: center;
            cursor: pointer;
            box-shadow: 0 5px 15px rgba(225, 48, 108, 0.4);
            transition: all 0.3s ease;
            border: 3px solid white;
        }

        .mini-player:hover {
            transform: scale(1.1);
            box-shadow: 0 8px 20px rgba(225, 48, 108, 0.6);
        }

        .mini-player i {
            color: white;
            font-size: 24px;
        }

        /* 播放器控制按钮 */
        .player-controls {
            display: flex;
            justify-content: space-around;
            padding: 15px;
            background: rgba(0, 0, 0, 0.05);
            border-top: 1px solid rgba(0, 0, 0, 0.1);
        }

        .control-btn {
            background: linear-gradient(135deg, #6a11cb, #2575fc);
            color: white;
            border: none;
            padding: 8px 20px;
            border-radius: 25px;
            cursor: pointer;
            display: flex;
            align-items: center;
            gap: 8px;
            font-size: 14px;
            transition: all 0.3s ease;
        }

        .control-btn:hover {
            transform: translateY(-2px);
            box-shadow: 0 5px 15px rgba(106, 17, 203, 0.4);
        }

        /* 播放器状态 */
        .player-status {
            padding: 10px 15px;
            background: rgba(0, 0, 0, 0.05);
            font-size: 14px;
            color: #666;
            text-align: center;
            border-bottom: 1px solid rgba(0, 0, 0, 0.1);
        }

        /* 播放列表选择器 */
        .playlist-selector {
            padding: 10px 15px;
            background: rgba(0, 0, 0, 0.02);
            border-bottom: 1px solid rgba(0, 0, 0, 0.05);
        }

        .playlist-selector select {
            width: 100%;
            padding: 8px;
            border-radius: 5px;
            border: 1px solid rgba(0, 0, 0, 0.1);
            background: white;
        }

        /* 响应式调整 */
        @media (max-width: 768px) {
            .music-player {
                bottom: 70px;
                right: 10px;
                max-width: 300px;
            }

            .music-player.expanded {
                width: 300px;
            }

            .music-player iframe {
                height: 200px;
            }
        }

        @media (max-width: 576px) {
            .music-player {
                bottom: 60px;
                right: 5px;
                max-width: 280px;
            }

            .music-player.expanded {
                width: 280px;
            }

            .music-player iframe {
                height: 180px;
            }

            .mini-player {
                width: 50px;
                height: 50px;
            }

            .mini-player i {
                font-size: 20px;
            }
        }

        /* ================== 主题切换样式 ================== */
        .theme-switcher {
            position: fixed;
            bottom: 20px;
            left: 20px;
            z-index: 1000;
        }

        .theme-btn {
            width: 50px;
            height: 50px;
            border-radius: 50%;
            border: none;
            background: linear-gradient(135deg, #6a11cb, #2575fc);
            color: white;
            cursor: pointer;
            display: flex;
            align-items: center;
            justify-content: center;
            box-shadow: 0 5px 15px rgba(0, 0, 0, 0.2);
            transition: all 0.3s ease;
        }

        .theme-btn:hover {
            transform: scale(1.1);
        }

        .theme-options {
            position: absolute;
            bottom: 60px;
            left: 0;
            background: rgba(255, 255, 255, 0.95);
            backdrop-filter: blur(10px);
            border-radius: 10px;
            padding: 10px;
            box-shadow: 0 5px 15px rgba(0, 0, 0, 0.1);
            display: none;
            min-width: 150px;
        }

        .theme-options.show {
            display: block;
        }

        .theme-option {
            padding: 8px 12px;
            border-radius: 5px;
            cursor: pointer;
            margin-bottom: 5px;
            transition: background 0.3s;
        }

        .theme-option:hover {
            background: rgba(0, 0, 0, 0.05);
        }

        .theme-option.active {
            background: rgba(13, 110, 253, 0.1);
            color: #0d6efd;
            font-weight: bold;
        }

        /* ================== 暗黑主题样式 ================== */
        body.dark-theme {
            background: linear-gradient(-45deg, #1a1a2e, #16213e, #0f3460, #1a1a2e);
            color: #e0e0e0;
        }

        body.dark-theme::before {
            background: rgba(0, 0, 0, 0.85);
        }

        body.dark-theme main.container {
            background: rgba(30, 30, 46, 0.95);
            color: #e0e0e0;
        }

        body.dark-theme .card {
            background: rgba(40, 40, 60, 0.95);
            color: #e0e0e0;
            border-color: rgba(255, 255, 255, 0.1);
        }

        body.dark-theme .jumbotron {
            background: rgba(40, 40, 60, 0.95) !important;
            color: #e0e0e0;
        }

        body.dark-theme .alert {
            background: rgba(40, 40, 60, 0.95);
            color: #e0e0e0;
            border-color: rgba(255, 255, 255, 0.1);
        }

        body.dark-theme .text-muted {
            color: #b0b0b0 !important;
        }

        /* ================== 返回顶部按钮 ================== */
        .back-to-top {
            position: fixed;
            bottom: 20px;
            right: 20px;
            z-index: 999;
            width: 50px;
            height: 50px;
            border-radius: 50%;
            background: linear-gradient(135deg, #6a11cb, #2575fc);
            color: white;
            border: none;
            cursor: pointer;
            display: flex;
            align-items: center;
            justify-content: center;
            box-shadow: 0 5px 15px rgba(0, 0, 0, 0.2);
            opacity: 0;
            visibility: hidden;
            transition: all 0.3s ease;
        }

        .back-to-top.show {
            opacity: 1;
            visibility: visible;
        }

        .back-to-top:hover {
            transform: translateY(-5px);
        }

        /* 修复导航栏按钮样式 */
        .navbar-nav .nav-link.btn-link {
            color: rgba(255, 255, 255, 0.75);
            text-decoration: none;
            padding: 0.5rem 1rem;
            border: none;
            background: transparent;
        }

        .navbar-nav .nav-link.btn-link:hover {
            color: white;
            background-color: rgba(255, 255, 255, 0.1);
        }

        .navbar-nav .nav-link.btn-link.active {
            color: white;
            font-weight: bold;
        }
    </style>
</head>
<body>
    <!-- 导入图片显示宏 -->
    {% from "_macros.html" import show_image %}

    <nav class="navbar navbar-expand-lg navbar-dark bg-dark fixed-top">
        <div class="container">
            <a class="navbar-brand" href="/">
                <i class="bi bi-images"></i> PicShare
            </a>

            <!-- 桌面端搜索框 -->
            <form class="d-none d-md-flex me-3" action="/search" method="get">
                <div class="input-group input-group-sm">
                    <input type="text" class="form-control"
                           name="q" placeholder="搜索图片..."
                           aria-label="搜索" style="width: 200px;">
                    <button class="btn btn-outline-light" type="submit">
                        <i class="bi bi-search"></i>
                    </button>
                </div>
            </form>

            <button class="navbar-toggler" type="button" data-bs-toggle="collapse" data-bs-target="#navbarNav">
                <span class="navbar-toggler-icon"></span>
            </button>
            <div class="collapse navbar-collapse" id="navbarNav">
                <ul class="navbar-nav me-auto">
                    <li class="nav-item">
                        <a class="nav-link active" href="/">
                            <i class="bi bi-house-door"></i> 首页
                        </a>
                    </li>
                    {% if current_user.is_authenticated %}
                    <li class="nav-item">
                        <a class="nav-link" href="/upload">
                            <i class="bi bi-cloud-arrow-up"></i> 上传
                        </a>
                    </li>
                    <li class="nav-item">
                        <a class="nav-link" href="/my-images">
                            <i class="bi bi-collection"></i> 我的图片
                        </a>
                    </li>
                    {% endif %}
                </ul>
                <ul class="navbar-nav">
                    <!-- 主题切换按钮 - 修复为纯按钮 -->
                    <li class="nav-item">
                        <a href="javascript:void(0);" class="nav-link" id="navThemeToggleBtn">
                            <i class="bi bi-palette"></i> 主题
                        </a>
                    </li>

                    <!-- 音乐控制按钮 - 修复为纯按钮 -->
                    <li class="nav-item">
                        <a href="javascript:void(0);" class="nav-link" id="navMusicToggleBtn">
                            <i class="bi bi-music-note"></i> 音乐
                        </a>
                    </li>

                    {% if current_user.is_authenticated %}
                        <li class="nav-item dropdown">
                            <a class="nav-link dropdown-toggle" href="#" id="userDropdown" role="button" data-bs-toggle="dropdown">
                                <i class="bi bi-person-circle"></i> {{ current_user.username }}
                            </a>
                            <ul class="dropdown-menu dropdown-menu-end">
                                <li><span class="dropdown-item-text">欢迎，{{ current_user.username }}</span></li>
                                <li><hr class="dropdown-divider"></li>
                                <li><a class="dropdown-item" href="/my-images">
                                    <i class="bi bi-collection"></i> 我的图片
                                </a></li>
                                <li><a class="dropdown-item" href="/music-settings">
                                    <i class="bi bi-music-note-beamed"></i> 音乐设置
                                </a></li>
                                <li><hr class="dropdown-divider"></li>
                                <li><a class="dropdown-item" href="/logout">
                                    <i class="bi bi-box-arrow-right"></i> 退出登录
                                </a></li>
                            </ul>
                        </li>
                    {% else %}
                        <li class="nav-item">
                            <a class="nav-link" href="/login">
                                <i class="bi bi-box-arrow-in-right"></i> 登录
                            </a>
                        </li>
                        <li class="nav-item">
                            <a class="nav-link" href="/register">
                                <i class="bi bi-person-plus"></i> 注册
                            </a>
                        </li>
                    {% endif %}
                </ul>
            </div>
        </div>
    </nav>

    <!-- 主题切换面板 - 只保留默认和暗黑主题 -->
    <div class="theme-switcher">
        <button class="theme-btn" id="themeBtn">
            <i class="bi bi-palette-fill"></i>
        </button>
        <div class="theme-options" id="themeOptions">
            <div class="theme-option active" data-theme="default">默认主题</div>
            <div class="theme-option" data-theme="dark">暗黑模式</div>
        </div>
    </div>

    <!-- 返回顶部按钮 -->
    <button class="back-to-top" id="backToTop">
        <i class="bi bi-arrow-up"></i>
    </button>

    <main class="container mt-5 pt-4">
        {% with messages = get_flashed_messages(with_categories=true) %}
            {% if messages %}
                {% for category, message in messages %}
                    <div class="alert alert-{{ category }} alert-dismissible fade show mt-3" role="alert">
                        {{ message }}
                        <button type="button" class="btn-close" data-bs-dismiss="alert"></button>
                    </div>
                {% endfor %}
            {% endif %}
        {% endwith %}

        {% if error_404 %}
            <div class="text-center py-5 mt-5">
                <h1 class="display-1 text-muted">404</h1>
                <h2 class="mb-4">页面未找到</h2>
                <p class="lead mb-4">抱歉，您访问的页面不存在。</p>
                <a href="/" class="btn btn-primary btn-lg">
                    <i class="bi bi-house-door"></i> 返回首页
                </a>
            </div>
        {% elif error_500 %}
            <div class="text-center py-5 mt-5">
                <h1 class="display-1 text-muted">500</h1>
                <h2 class="mb-4">服务器错误</h2>
                <p class="lead mb-4">抱歉，服务器出现了问题。</p>
                <a href="/" class="btn btn-primary btn-lg">
                    <i class="bi bi-house-door"></i> 返回首页
                </a>
            </div>
        {% elif error_413 %}
            <div class="text-center py-5 mt-5">
                <h1 class="display-1 text-muted">413</h1>
                <h2 class="mb-4">文件过大</h2>
                <p class="lead mb-4">上传的文件大小超过限制（最大16MB）。</p>
                <a href="/" class="btn btn-primary btn-lg">
                    <i class="bi bi-house-door"></i> 返回首页
                </a>
            </div>
        {% else %}
            <div class="jumbotron bg-light p-5 rounded-3 mb-4">
                <h1 class="display-4">欢迎来到 PicShare!</h1>
                <p class="lead" style="color: green;">男孩别哭</p>
                <hr class="my-4">
                {% if not current_user.is_authenticated %}
                    <a class="btn btn-primary btn-lg me-2" href="/register" role="button">
                        <i class="bi bi-person-plus"></i> 立即加入
                    </a>
                {% endif %}
                <a class="btn btn-outline-secondary btn-lg" href="/upload" role="button">
                    <i class="bi bi-cloud-arrow-up"></i> 上传图片
                </a>

                <!-- 快捷功能按钮组 -->
                <div class="mt-3">
                    <button class="btn btn-outline-info btn-sm me-2" id="toggleMusicBtn">
                        <i class="bi bi-music-note-beamed"></i> 播放音乐
                    </button>
                    <button class="btn btn-outline-warning btn-sm me-2" id="toggleThemeBtn">
                        <i class="bi bi-moon"></i> 切换主题
                    </button>
                    <button class="btn btn-outline-success btn-sm" id="randomImageBtn">
                        <i class="bi bi-shuffle"></i> 随机图片
                    </button>
                </div>
            </div>

            <!-- 移动端搜索框 -->
            <div class="d-md-none mb-4">
                <form action="/search" method="get">
                    <div class="input-group">
                        <input type="text" class="form-control"
                               name="q" placeholder="搜索图片标题、描述或作者...">
                        <button class="btn btn-primary" type="submit">
                            <i class="bi bi-search"></i> 搜索
                        </button>
                    </div>
                </form>
            </div>

            <div class="d-flex justify-content-between align-items-center mb-4">
                <h2><i class="bi bi-images"></i> 最新图片</h2>
                <div>
                    <span class="badge bg-primary me-2">
                        {% if images is mapping and 'total' in images %}
                            共 {{ images.total }} 张图片 (第 {{ images.page }}/{{ images.pages }} 页)
                        {% elif images is iterable and images is not string %}
                            {{ images|length }} 张图片
                        {% else %}
                            0 张图片
                        {% endif %}
                    </span>
                    <button class="btn btn-outline-secondary btn-sm" id="refreshBtn">
                        <i class="bi bi-arrow-clockwise"></i> 刷新
                    </button>
                </div>
            </div>

            {% if images is mapping and 'items' in images %}
                <!-- 分页模式：images 是字典，包含 items -->
                {% if images.items %}
                    <div class="row row-cols-1 row-cols-md-2 row-cols-lg-3 g-4">
                        {% for image in images.items %}
                        <div class="col">
                            <div class="card h-100 shadow-sm">
                                <div class="img-container">
                                    <a href="/image/{{ image.id }}">
                                        {{ show_image(image, 'card-img-top') }}
                                    </a>
                                </div>
                                <div class="card-body">
                                    <h5 class="card-title">{{ image.title if image.title else image.original_filename }}</h5>
                                    <p class="card-text text-truncate-2">{{ image.description if image.description else '暂无描述' }}</p>
                                </div>
                                <div class="card-footer bg-transparent">
                                    <div class="d-flex justify-content-between align-items-center">
                                        <div>
                                            <a href="/like/{{ image.id }}" class="btn btn-outline-primary btn-sm">
                                                <i class="bi bi-hand-thumbs-up"></i> {{ image.likes }}
                                            </a>
                                            <a href="/image/{{ image.id }}" class="btn btn-outline-secondary btn-sm ms-1">
                                                <i class="bi bi-eye"></i> {{ image.views }}
                                            </a>
                                        </div>
                                        <small class="text-muted">
                                            <i class="bi bi-calendar"></i> {{ image.upload_time.strftime('%Y-%m-%d') if image.upload_time else '未知时间' }}
                                        </small>
                                    </div>
                                    <!-- 修复删除按钮：管理员也可以删除 -->
                                    {% if current_user.is_authenticated and (current_user.id == image.user_id or current_user.is_admin) %}
                                    <form action="/delete/{{ image.id }}" method="POST" class="mt-2" onsubmit="return confirm('确定要删除这张图片吗？');">
                                        <button type="submit" class="btn btn-danger btn-sm w-100">
                                            <i class="bi bi-trash"></i>
                                            {% if current_user.id == image.user_id %}
                                                删除
                                            {% else %}
                                                管理员删除
                                            {% endif %}
                                        </button>
                                    </form>
                                    {% endif %}
                                </div>
                            </div>
                        </div>
                        {% endfor %}
                    </div>

                    <!-- 分页导航 -->
                    {% if images.pages > 1 %}
                    <nav aria-label="图片分页" class="mt-4">
                        <ul class="pagination justify-content-center">
                            <!-- 上一页 -->
                            {% if images.page > 1 %}
                            <li class="page-item">
                                <a class="page-link" href="?page={{ images.page - 1 }}" aria-label="上一页">
                                    <i class="bi bi-chevron-left"></i> 上一页
                                </a>
                            </li>
                            {% else %}
                            <li class="page-item disabled">
                                <span class="page-link">
                                    <i class="bi bi-chevron-left"></i> 上一页
                                </span>
                            </li>
                            {% endif %}

                            <!-- 页码 -->
                            {% for page_num in range(1, images.pages + 1) %}
                                {% if page_num == images.page %}
                                <li class="page-item active">
                                    <span class="page-link">{{ page_num }}</span>
                                </li>
                                {% elif page_num >= images.page - 2 and page_num <= images.page + 2 %}
                                <li class="page-item">
                                    <a class="page-link" href="?page={{ page_num }}">{{ page_num }}</a>
                                </li>
                                {% elif page_num == 1 %}
                                <li class="page-item">
                                    <a class="page-link" href="?page=1">1</a>
                                </li>
                                {% elif page_num == images.pages %}
                                <li class="page-item">
                                    <a class="page-link" href="?page={{ images.pages }}">{{ images.pages }}</a>
                                </li>
                                {% elif page_num == images.page - 3 or page_num == images.page + 3 %}
                                <li class="page-item disabled">
                                    <span class="page-link">...</span>
                                </li>
                                {% endif %}
                            {% endfor %}

                            <!-- 下一页 -->
                            {% if images.page < images.pages %}
                            <li class="page-item">
                                <a class="page-link" href="?page={{ images.page + 1 }}" aria-label="下一页">
                                    下一页 <i class="bi bi-chevron-right"></i>
                                </a>
                            </li>
                            {% else %}
                            <li class="page-item disabled">
                                <span class="page-link">
                                    下一页 <i class="bi bi-chevron-right"></i>
                                </span>
                            </li>
                            {% endif %}
                        </ul>
                    </nav>
                    {% endif %}
                {% else %}
                    <div class="text-center py-5">
                        <div class="mb-4">
                            <i class="bi bi-images" style="font-size: 4rem; color: #6c757d;"></i>
                        </div>
                        <h3 class="text-muted mb-3">还没有图片</h3>
                        <p class="lead mb-4">成为第一个分享图片的人吧！</p>
                        <a href="/upload" class="btn btn-primary btn-lg">
                            <i class="bi bi-cloud-arrow-up"></i> 上传第一张图片
                        </a>
                    </div>
                {% endif %}

            {% elif images is iterable and images is not string %}
                <!-- 旧模式：images 是列表 -->
                {% if images %}
                    <div class="row row-cols-1 row-cols-md-2 row-cols-lg-3 g-4">
                        {% for image in images %}
                        <div class="col">
                            <div class="card h-100 shadow-sm">
                                <div class="img-container">
                                    <a href="/image/{{ image.id }}">
                                        {{ show_image(image, 'card-img-top') }}
                                    </a>
                                </div>
                                <div class="card-body">
                                    <h5 class="card-title">{{ image.title if image.title else image.original_filename }}</h5>
                                    <p class="card-text text-truncate-2">{{ image.description if image.description else '暂无描述' }}</p>
                                </div>
                                <div class="card-footer bg-transparent">
                                    <div class="d-flex justify-content-between align-items-center">
                                        <div>
                                            <a href="/like/{{ image.id }}" class="btn btn-outline-primary btn-sm">
                                                <i class="bi bi-hand-thumbs-up"></i> {{ image.likes }}
                                            </a>
                                            <a href="/image/{{ image.id }}" class="btn btn-outline-secondary btn-sm ms-1">
                                                <i class="bi bi-eye"></i> {{ image.views }}
                                            </a>
                                        </div>
                                        <small class="text-muted">
                                            <i class="bi bi-calendar"></i> {{ image.upload_time.strftime('%Y-%m-d') if image.upload_time else '未知时间' }}
                                        </small>
                                    </div>
                                    <!-- 修复删除按钮：管理员也可以删除 -->
                                    {% if current_user.is_authenticated and (current_user.id == image.user_id or current_user.is_admin) %}
                                    <form action="/delete/{{ image.id }}" method="POST" class="mt-2" onsubmit="return confirm('确定要删除这张图片吗？');">
                                        <button type="submit" class="btn btn-danger btn-sm w-100">
                                            <i class="bi bi-trash"></i>
                                            {% if current_user.id == image.user_id %}
                                                删除
                                            {% else %}
                                                管理员删除
                                            {% endif %}
                                        </button>
                                    </form>
                                    {% endif %}
                                </div>
                            </div>
                        </div>
                        {% endfor %}
                    </div>
                {% else %}
                    <div class="text-center py-5">
                        <div class="mb-4">
                            <i class="bi bi-images" style="font-size: 4rem; color: #6c757d;"></i>
                        </div>
                        <h3 class="text-muted mb-3">还没有图片</h3>
                        <p class="lead mb-4">成为第一个分享图片的人吧！</p>
                        <a href="/upload" class="btn btn-primary btn-lg">
                            <i class="bi bi-cloud-arrow-up"></i> 上传第一张图片
                        </a>
                    </div>
                {% endif %}
            {% else %}
                <!-- 此处省略原代码未显示的闭合标签 -->
            {% endif %}
        {% endif %}
    </main>

    <!-- 音乐播放器 -->
    <div class="music-player collapsed" id="musicPlayer">
        <div class="mini-player" id="miniPlayer">
            <i class="bi bi-music-note-beamed"></i>
        </div>
        <div class="player-content">
            <div class="player-header" id="playerHeader">
                <h5><i class="bi bi-music-note"></i> 音乐播放器</h5>
                <button class="close-btn" id="closePlayer">×</button>
            </div>
            <div class="player-status" id="playerStatus">
                点击展开播放器
            </div>
            <div class="playlist-selector">
                <select id="playlistSelect">
                    <option value="3778678">网易云热歌榜</option>
                    <option value="3779629">网易云新歌榜</option>
                    <option value="19723756">网易云飙升榜</option>
                    <option value="71385702">网络热歌</option>
                    <option value="2894911459">经典老歌</option>
                    <option value="5059633707">纯音乐/轻音乐</option>
                </select>
            </div>
            <div class="player-controls">
                <button class="control-btn" id="prevSongBtn">
                    <i class="bi bi-skip-backward"></i> 上一首
                </button>
                <button class="control-btn" id="nextSongBtn">
                    <i class="bi bi-skip-forward"></i> 下一首
                </button>
            </div>
            <!-- 网易云音乐播放器 -->
            <iframe
                frameborder="no"
                border="0"
                marginwidth="0"
                marginheight="0"
                width="100%"
                height="200"
                id="neteasePlayer"
                src="https://music.163.com/outchain/player?type=0&id=3778678&auto=1&height=200">
            </iframe>
        </div>
    </div>

    <!-- 主题切换和音乐播放器JavaScript代码 -->
    <script>
        // 等待页面加载完成
        document.addEventListener('DOMContentLoaded', function() {
            // ============== 主题切换功能 ==============
            // 获取主题相关元素
            const themeBtn = document.getElementById('themeBtn');
            const themeOptions = document.getElementById('themeOptions');
            const themeOptionsItems = document.querySelectorAll('.theme-option');
            const toggleThemeBtn = document.getElementById('toggleThemeBtn');
            const navThemeToggleBtn = document.getElementById('navThemeToggleBtn');

            // 切换主题选项面板显示/隐藏
            themeBtn.addEventListener('click', function() {
                themeOptions.classList.toggle('show');
            });

            // 点击其他区域关闭主题选项面板
            document.addEventListener('click', function(event) {
                if (!themeBtn.contains(event.target) && !themeOptions.contains(event.target)) {
                    themeOptions.classList.remove('show');
                }
            });

            // 切换主题
            function changeTheme(theme) {
                // 移除所有主题类
                document.body.classList.remove('dark-theme');
                // 移除所有选项的active类
                themeOptionsItems.forEach(item => item.classList.remove('active'));

                // 如果不是默认主题，添加对应的主题类
                if (theme !== 'default') {
                    document.body.classList.add(`${theme}-theme`);
                }

                // 为当前选中的主题选项添加active类
                document.querySelector(`.theme-option[data-theme="${theme}"]`).classList.add('active');

                // 保存主题偏好到本地存储
                localStorage.setItem('theme', theme);

                // 关闭主题选项面板
                themeOptions.classList.remove('show');
            }

            // 为每个主题选项添加点击事件
            themeOptionsItems.forEach(item => {
                item.addEventListener('click', function() {
                    const theme = this.getAttribute('data-theme');
                    changeTheme(theme);
                });
            });

            // 导航栏主题按钮点击事件 - 切换暗黑模式
            navThemeToggleBtn.addEventListener('click', function(e) {
                e.preventDefault();
                const isDark = document.body.classList.contains('dark-theme');
                changeTheme(isDark ? 'default' : 'dark');
            });

            // 快捷功能区主题按钮点击事件 - 切换暗黑模式
            toggleThemeBtn.addEventListener('click', function() {
                const isDark = document.body.classList.contains('dark-theme');
                changeTheme(isDark ? 'default' : 'dark');
            });

            // 加载保存的主题偏好
            const savedTheme = localStorage.getItem('theme') || 'default';
            changeTheme(savedTheme);

            // ============== 音乐播放器功能 ==============
            // 获取音乐播放器相关元素
            const musicPlayer = document.getElementById('musicPlayer');
            const miniPlayer = document.getElementById('miniPlayer');
            const playerHeader = document.getElementById('playerHeader');
            const closePlayer = document.getElementById('closePlayer');
            const navMusicToggleBtn = document.getElementById('navMusicToggleBtn');
            const toggleMusicBtn = document.getElementById('toggleMusicBtn');
            const playerStatus = document.getElementById('playerStatus');
            const playlistSelect = document.getElementById('playlistSelect');
            const neteasePlayer = document.getElementById('neteasePlayer');

            // 初始化播放器状态
            let isMusicPlayerExpanded = false;

            // 公开歌单列表
            const playlists = {
                '3778678': '网易云热歌榜',
                '3779629': '网易云新歌榜',
                '19723756': '网易云飙升榜',
                '71385702': '网络热歌',
                '2894911459': '经典老歌',
                '5059633707': '纯音乐/轻音乐'
            };

            // 展开音乐播放器
            function expandMusicPlayer() {
                musicPlayer.classList.remove('collapsed');
                musicPlayer.classList.add('expanded');
                document.body.classList.add('has-music-player');

                // 获取当前选中的歌单名称
                const selectedPlaylistId = playlistSelect.value;
                const playlistName = playlists[selectedPlaylistId] || '未知歌单';
                playerStatus.textContent = `正在播放：${playlistName}`;

                isMusicPlayerExpanded = true;
            }

            // 折叠音乐播放器
            function collapseMusicPlayer() {
                musicPlayer.classList.remove('expanded');
                musicPlayer.classList.add('collapsed');
                document.body.classList.remove('has-music-player');
                playerStatus.textContent = '点击展开播放器';
                isMusicPlayerExpanded = false;
            }

            // 切换音乐播放器状态
            function toggleMusicPlayer() {
                if (isMusicPlayerExpanded) {
                    collapseMusicPlayer();
                } else {
                    expandMusicPlayer();
                }
            }

            // 切换歌单
            function changePlaylist(playlistId) {
                // 更新播放器iframe的src
                neteasePlayer.src = `https://music.163.com/outchain/player?type=0&id=${playlistId}&auto=1&height=200`;

                // 更新状态显示
                const playlistName = playlists[playlistId] || '未知歌单';
                playerStatus.textContent = `正在播放：${playlistName}`;

                // 保存当前选择的歌单到本地存储
                localStorage.setItem('selectedPlaylist', playlistId);
            }

            // 迷你播放器点击事件
            miniPlayer.addEventListener('click', toggleMusicPlayer);

            // 播放器头部点击事件
            playerHeader.addEventListener('click', toggleMusicPlayer);

            // 关闭按钮点击事件
            closePlayer.addEventListener('click', function(e) {
                e.stopPropagation();
                collapseMusicPlayer();
            });

            // 导航栏音乐按钮点击事件
            navMusicToggleBtn.addEventListener('click', function(e) {
                e.preventDefault();
                toggleMusicPlayer();
            });

            // 快捷功能区音乐按钮点击事件
            toggleMusicBtn.addEventListener('click', toggleMusicPlayer);

            // 歌单选择器变化事件
            playlistSelect.addEventListener('change', function() {
                changePlaylist(this.value);
            });

            // 上一首按钮点击事件 - 切换到上一个歌单
            document.getElementById('prevSongBtn').addEventListener('click', function() {
                const options = Array.from(playlistSelect.options);
                const currentIndex = playlistSelect.selectedIndex;
                const prevIndex = (currentIndex - 1 + options.length) % options.length;
                playlistSelect.selectedIndex = prevIndex;
                changePlaylist(options[prevIndex].value);
            });

            // 下一首按钮点击事件 - 切换到下一个歌单
            document.getElementById('nextSongBtn').addEventListener('click', function() {
                const options = Array.from(playlistSelect.options);
                const currentIndex = playlistSelect.selectedIndex;
                const nextIndex = (currentIndex + 1) % options.length;
                playlistSelect.selectedIndex = nextIndex;
                changePlaylist(options[nextIndex].value);
            });

            // 加载保存的歌单偏好
            const savedPlaylist = localStorage.getItem('selectedPlaylist');
            if (savedPlaylist && playlistSelect.querySelector(`option[value="${savedPlaylist}"]`)) {
                playlistSelect.value = savedPlaylist;
                // 如果播放器已展开，更新播放器
                if (musicPlayer.classList.contains('expanded')) {
                    changePlaylist(savedPlaylist);
                }
            }

            // ============== 返回顶部功能 ==============
            const backToTop = document.getElementById('backToTop');

            window.addEventListener('scroll', function() {
                if (window.scrollY > 300) {
                    backToTop.classList.add('show');
                } else {
                    backToTop.classList.remove('show');
                }
            });

            backToTop.addEventListener('click', function() {
                window.scrollTo({
                    top: 0,
                    behavior: 'smooth'
                });
            });

            // ============== 其他功能 ==============
            // 刷新按钮
            const refreshBtn = document.getElementById('refreshBtn');
            refreshBtn.addEventListener('click', function() {
                window.location.reload();
            });

            // 随机图片按钮
            const randomImageBtn = document.getElementById('randomImageBtn');
            randomImageBtn.addEventListener('click', function() {
                // 如果有图片，跳转到随机一张图片
                const images = document.querySelectorAll('.card a[href^="/image/"]');
                if (images.length > 0) {
                    const randomIndex = Math.floor(Math.random() * images.length);
                    const randomImage = images[randomIndex];
                    window.location.href = randomImage.getAttribute('href');
                } else {
                    alert('暂无图片');
                }
            });

            // 添加旋转动画样式
            const style = document.createElement('style');
            style.textContent = `
                @keyframes spin {
                    0% { transform: rotate(0deg); }
                    100% { transform: rotate(360deg); }
                }
                .spin {
                    animation: spin 1s linear infinite;
                    display: inline-block;
                    margin-right: 5px;
                }
            `;
            document.head.appendChild(style);
        });
    </script>
</body>
</html>